<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý sản phẩm - MuaRight</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../../public/CSS/seller/products_page.css">
</head>
<body>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h4><div class="logo-icon"><i class="fas fa-gem"></i></div><span>MuaRight</span></h4>
        </div>
        <ul class="sidebar-menu">
            <li><a href="homeSeller_page.html"><i class="fas fa-chart-line"></i> Dashboard</a></li>
            <li><a href="products_page.html" class="active"><i class="fas fa-box"></i> Quản lý sản phẩm</a></li>
            <li><a href="orders_page.html"><i class="fas fa-shopping-cart"></i> Quản lý đơn hàng</a></li>
            <li><a href="vouchers_page.html"><i class="fas fa-tags"></i> Quản lý Voucher</a></li>
            <li><a href="satisfaction_page.html"><i class="fas fa-chart-bar"></i> Thống kê doanh thu</a></li>
            <li><a href="profileSeller_page.html"><i class="fas fa-cog"></i> Cài đặt trang cá nhân</a></li>
            <li><a href="#logout" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Đăng xuất</a></li>
        </ul>
    </div>

    <div class="main-content">
        <div class="page-header d-flex justify-content-between align-items-center">
            <h2><i class="fas fa-box"></i> Quản lý sản phẩm</h2>
            <button class="btn btn-primary" id="showAddProductFormBtn">
                <i class="fas fa-plus"></i> Thêm sản phẩm mới
            </button>
        </div>

        <div id="mainViewContainer">
            <div class="stats-summary" id="productStats">
                <div class="stat-box"><i class="fas fa-box-open"></i><h4 id="totalProducts">0</h4><p>Tổng sản phẩm</p></div>
                <div class="stat-box"><i class="fas fa-check-circle"></i><h4 id="activeProducts">0</h4><p>Đang bán</p></div>
                <div class="stat-box"><i class="fas fa-exclamation-triangle"></i><h4 id="outOfStock">0</h4><p>Hết hàng</p></div>
                <div class="stat-box"><i class="fas fa-star"></i><h4 id="avgRating">0</h4><p>Đánh giá TB</p></div>
            </div>

            <div class="filter-bar d-flex gap-3 align-items-center" id="filterBar">
                <div class="search-box flex-grow-1">
                    <input type="text" id="searchInput" class="form-control" placeholder="Tìm kiếm theo tên, tags (VD: Chanel, nam tính)...">
                    <i class="fas fa-search"></i>
                </div>
            </div>

            <div class="row g-4" id="productsContainer">
                <!-- Sản phẩm sẽ được tải từ API-->
            </div>
        </div>


        <!-- Thêm sản phẩm -->
        <div id="addProductSection" class="card" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-plus-circle"></i> Gửi yêu cầu thêm sản phẩm mới</h5>
            </div>
            <div class="card-body">
                <form id="addProductForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Tên sản phẩm*</label>
                            <input type="text" class="form-control" name="NameProduct" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Danh mục*</label>
                            <input list="categoryOptions" class="form-control" name="Category" placeholder="Chọn hoặc nhập danh mục" required>
                            <datalist id="categoryOptions">
                                <option value="Nước hoa Nam">
                                <option value="Nước hoa Nữ">
                                <option value="Nước hoa Unisex">
                                <option value="Nước hoa Mini">
                                <option value="Body Mist">
                            </datalist>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Giá bán (VNĐ)*</label>
                            <input type="number" class="form-control" name="Price" min="0" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Số lượng tồn kho*</label>
                            <input type="number" class="form-control" name="Quantity" min="0" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Link hình ảnh*</label>
                        <input type="url" class="form-control" name="ImageUrl" placeholder="https://example.com/image.png" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Tags*</label>
                        <input list="tagOptions" type="text" class="form-control" name="TagName" placeholder="Các từ khóa cách nhau bởi dấu phẩy, VD: Chanel, hương gỗ, nam tính" required>
                        <datalist id="tagOptions">
                            <option value="Chanel">
                            <option value="Dior">
                            <option value="Gucci">
                            <option value="Hương hoa cỏ">
                            <option value="Hương gỗ">
                            <option value="Mùi hương ngọt ngào">
                            <option value="Sang trọng">
                            <option value="Nam tính">
                        </datalist>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Bảo hành</label>
                        <input list="warrantyOptions" class="form-control" name="Warranty" placeholder="Chọn hoặc nhập chính sách bảo hành">
                        <datalist id="warrantyOptions">
                            <option value="Bảo hành mùi hương trọn đời">
                            <option value="Đổi trả trong 7 ngày nếu lỗi">
                            <option value="Không bảo hành">
                        </datalist>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Mô tả sản phẩm</label>
                        <textarea class="form-control" name="Description" rows="4" placeholder="Mô tả chi tiết về các tầng hương, xuất xứ, dung tích..."></textarea>
                    </div>

                    <div class="d-flex justify-content-end gap-2 mt-3">
                        <button type="button" class="btn btn-outline-secondary" id="cancelAddProductBtn">Hủy</button>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane"></i> Gửi đi duyệt</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="productDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-info-circle"></i> Chi tiết sản phẩm</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="productDetailContent"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editProductModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title"><i class="fas fa-edit"></i> Chỉnh sửa sản phẩm</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                     <form id="editProductForm">
                        <input type="hidden" name="ProductId" id="editProductId">
                        <div class="row">
                            <div class="col-md-6 mb-3"><label class="form-label">Tên sản phẩm*</label><input type="text" class="form-control" name="NameProduct" id="editName" required></div>
                            <div class="col-md-6 mb-3"><label class="form-label">Danh mục*</label><input type="text" class="form-control" name="Category" id="editCategory" required></div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3"><label class="form-label">Giá bán (VNĐ)*</label><input type="number" class="form-control" name="Price" id="editPrice" required></div>
                            <div class="col-md-6 mb-3"><label class="form-label">Số lượng tồn kho*</label><input type="number" class="form-control" name="Quantity" id="editStock" required></div>
                        </div>
                        <div class="mb-3"><label class="form-label">Tags*</label><input type="text" class="form-control" name="TagName" id="editTagName" required></div>
                        <div class="mb-3"><label class="form-label">Bảo hành</label><input type="text" class="form-control" name="Warranty" id="editWarranty"></div>
                        <div class="mb-3"><label class="form-label">Mô tả sản phẩm</label><textarea class="form-control" name="Description" id="editDescription" rows="4"></textarea></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="saveEditProduct()"><i class="fas fa-save"></i> Cập nhật</button>
                </div>
            </div>
        </div>
    </div>
    
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API_URL = "http://localhost:3000";
    let sellerId = null;
    let allProducts = [];
    let account = null;
    let isAddingProduct = false;

    function toggleAddProductView(showForm) {
        const mainViewContainer = document.getElementById('mainViewContainer');
        const addProductSection = document.getElementById('addProductSection');
        const pageHeaderTitle = document.querySelector('.page-header h2');
        const showAddProductFormBtn = document.getElementById('showAddProductFormBtn');
        const addProductForm = document.getElementById('addProductForm');

        isAddingProduct = showForm;

        if (showForm) {
            mainViewContainer.style.display = 'none';
            addProductSection.style.display = 'block';
            pageHeaderTitle.innerHTML = `<i class="fas fa-plus-circle"></i> Thêm sản phẩm mới`;
            showAddProductFormBtn.innerHTML = `<i class="fas fa-list"></i> Quay lại danh sách`;
            showAddProductFormBtn.classList.replace('btn-primary', 'btn-secondary');
        } else {
            mainViewContainer.style.display = 'block';
            addProductSection.style.display = 'none';
            pageHeaderTitle.innerHTML = `<i class="fas fa-box"></i> Quản lý sản phẩm`;
            showAddProductFormBtn.innerHTML = `<i class="fas fa-plus"></i> Thêm sản phẩm mới`;
            showAddProductFormBtn.classList.replace('btn-secondary', 'btn-primary');
            addProductForm.reset(); 
            fetchProducts();
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const showAddProductFormBtn = document.getElementById('showAddProductFormBtn');
        const addProductForm = document.getElementById('addProductForm');
        
        const accountString = localStorage.getItem("account");
        if (!accountString) {
            alert("Vui lòng đăng nhập để truy cập.");
            window.location.href = "../../template/pages/signIn_page.html";
            return;
        }
        account = JSON.parse(accountString);
        if (account.Role !== 'Seller') {
            alert("Bạn không có quyền truy cập trang này.");
            window.location.href = "../../template/pages/signIn_page.html";
            return;
        }
        sellerId = account.AccountId;

        fetchProducts();
        document.getElementById('searchInput').addEventListener('input', applyFilters);
        document.getElementById('logoutBtn').addEventListener('click', (e) => {
            e.preventDefault();
            if (confirm("Bạn có chắc chắn muốn đăng xuất?")) {
                localStorage.removeItem('account');
                window.location.href = '../../template/pages/signIn_page.html';
            }
        });

        showAddProductFormBtn.addEventListener('click', () => toggleAddProductView(!isAddingProduct));
        document.getElementById('cancelAddProductBtn').addEventListener('click', () => toggleAddProductView(false));
        addProductForm.addEventListener('submit', handleAddProductSubmit);
    });

    async function fetchProducts() {
        try {
            const response = await fetch(`${API_URL}/seller/products/${sellerId}`);
            const result = await response.json();
            if (result.success) {
                allProducts = result.data;
                displayProducts(allProducts);
                updateStats(allProducts);
            } else { 
                alert('Lỗi khi tải sản phẩm: ' + result.message);
            }
        } catch (error) {
            console.error('Lỗi fetchProducts:', error);
            alert('Không thể kết nối đến server để tải danh sách sản phẩm.');
        }
    }

    function displayProducts(products) {
        const container = document.getElementById('productsContainer');
        container.innerHTML = '';
        if (products.length === 0) {
            container.innerHTML = `<p class="text-center text-muted mt-5 w-100">Bạn chưa có sản phẩm nào được duyệt hoặc đang bán.</p>`;
            return;
        }
        products.forEach(p => container.insertAdjacentHTML('beforeend', createProductCard(p)));
    }

    function createProductCard(p) {
        const statusClass = p.Quantity > 0 ? 'active' : 'inactive';
        const statusText = p.Quantity > 0 ? 'Đang bán' : 'Hết hàng';
        return `
            <div class="col-lg-3 col-md-4 col-sm-6">
                <div class="product-card">
                    <div class="product-image">
                        <img src="${p.ImageUrl}" alt="${p.NameProduct}" onerror="this.onerror=null;this.src='../../public/images/default-product.png';">
                        <span class="product-status ${statusClass}">${statusText}</span>
                    </div>
                    <div class="product-info">
                        <div class="product-name product-name-clickable" title="${p.NameProduct}" onclick='openDetailModal(${JSON.stringify(p)})'>${p.NameProduct}</div>
                        <div class="product-price">${formatPrice(p.Price)}</div>
                        <div class="product-meta">
                            <span><i class="fas fa-box"></i> Tồn: ${p.Quantity}</span>
                            <span title="Đánh giá"><i class="fas fa-star text-warning"></i> ${parseFloat(p.AverageRating).toFixed(1)} (${p.ReviewCount})</span>
                        </div>
                        <div class="product-actions">
                            <button class="btn-action btn-edit" onclick='openEditModal(${JSON.stringify(p)})'><i class="fas fa-edit"></i> Sửa</button>
                            <button class="btn-action btn-delete" onclick="deleteProduct(${p.ProductId})"><i class="fas fa-trash"></i> Xóa</button>
                        </div>
                    </div>
                </div>
            </div>`;
    }
    
    function updateStats(products) {
        document.getElementById('totalProducts').textContent = products.length;
        document.getElementById('activeProducts').textContent = products.filter(p => p.Quantity > 0).length;
        document.getElementById('outOfStock').textContent = products.filter(p => p.Quantity === 0).length;
        const totalReviews = products.reduce((sum, p) => sum + p.ReviewCount, 0);
        const weightedSum = products.reduce((sum, p) => sum + (parseFloat(p.AverageRating) * p.ReviewCount), 0);
        const avgRating = totalReviews > 0 ? (weightedSum / totalReviews).toFixed(1) : '0.0';
        document.getElementById('avgRating').textContent = avgRating;
    }

    function applyFilters() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const filtered = allProducts.filter(p => 
            p.NameProduct.toLowerCase().includes(searchTerm) ||
            p.TagName.toLowerCase().includes(searchTerm)
        );
        displayProducts(filtered);
    }

    async function handleAddProductSubmit(event) {
        event.preventDefault(); 
        const form = event.target;
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        const formData = new FormData(form);
        const productData = Object.fromEntries(formData.entries());
        productData.SellerId = sellerId;
        productData.Price = parseFloat(productData.Price);
        productData.Quantity = parseInt(productData.Quantity);

        const price = parseFloat(productData.Price);
        const quantity = parseInt(productData.Quantity);

        if (productData.Price < 0) {
            alert("Giá bán không được âm. Vui lòng nhập lại!");
            document.querySelector('input[name="Price"]').value = '';
            return;
        }
        if (productData.Quantity < 0) {
            alert("Số lượng tồn không được âm. Vui lòng nhập lại!");
            document.querySelector('input[name="Quantity"]').value = '';
            return;
        }


        try {
            const response = await fetch(`${API_URL}/seller/products/submit`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(productData),
            });
            const result = await response.json();
            alert(result.message);
            if (result.success) {
                toggleAddProductView(false);
            }
        } catch (error) {
            console.error("Lỗi addProduct:", error);
            alert('Đã xảy ra lỗi khi gửi sản phẩm.');
        }
    }
    
    async function openDetailModal(product) {
        const modalBody = document.getElementById('productDetailContent');
        modalBody.innerHTML = `
            <div class="row">
                <div class="col-md-4 text-center">
                    <img src="${product.ImageUrl}" class="img-fluid rounded mb-3" alt="${product.NameProduct}" onerror="this.onerror=null;this.src='../../public/images/default-product.png';">
                </div>
                <div class="col-md-8">
                    <h4>${product.NameProduct}</h4>
                    <p class="text-primary fs-5 fw-bold">${formatPrice(product.Price)}</p>
                    <p><strong>Danh mục:</strong> ${product.Category}</p>
                    <p><strong>Tồn kho:</strong> ${product.Quantity} sản phẩm</p>
                    <p><strong>Đánh giá:</strong> <i class="fas fa-star text-warning"></i> ${parseFloat(product.AverageRating).toFixed(1)} (${product.ReviewCount} lượt)</p>
                    <p><strong>Bảo hành:</strong> ${product.Warranty || 'Không có'}</p>
                    <p><strong>Tags:</strong> <span class="badge bg-secondary">${product.TagName.split(',').join('</span> <span class="badge bg-secondary">')}</span></p>
                </div>
            </div>
            <hr>
            <h5>Mô tả chi tiết</h5>
            <p>${product.Description || 'Chưa có mô tả cho sản phẩm này.'}</p>
            <hr>
            <h5>Đánh giá từ khách hàng (${product.ReviewCount} lượt)</h5>
            <div id="productReviews" class="list-group">
                <!-- Reviews will be loaded here -->
            </div>
        `;

        await loadProductReviews(product.ProductId);

        const detailModal = new bootstrap.Modal(document.getElementById('productDetailModal'));
        detailModal.show();
    }

    async function loadProductReviews(productId) {
        const reviewsContainer = document.getElementById('productReviews');
        reviewsContainer.innerHTML = '<p class="text-muted">Đang tải đánh giá...</p>';
        try {
            const response = await fetch(`${API_URL}/seller/products/${productId}/reviews`);
            const result = await response.json();
            if (result.success && result.data.length > 0) {
                reviewsContainer.innerHTML = ''; 
                result.data.forEach(review => {
                    reviewsContainer.insertAdjacentHTML('beforeend', `
                        <div class="list-group-item list-group-item-action flex-column align-items-start">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">${review.CustomerName || 'Khách hàng ẩn danh'}</h6>
                                <small class="text-muted">${new Date(review.CreatedAt).toLocaleDateString('vi-VN')}</small>
                            </div>
                            <p class="mb-1">
                                ${'<i class="fas fa-star text-warning"></i>'.repeat(review.Rating)}
                                ${'<i class="far fa-star text-warning"></i>'.repeat(5 - review.Rating)}
                            </p>
                            <p class="mb-1">${review.Comment || 'Không có bình luận.'}</p>
                        </div>
                    `);
                });
            } else {
                reviewsContainer.innerHTML = '<p class="text-muted">Chưa có đánh giá nào cho sản phẩm này.</p>';
            }
        } catch (error) {
            console.error('Lỗi khi tải đánh giá:', error);
            reviewsContainer.innerHTML = '<p class="text-danger">Không thể tải đánh giá.</p>';
        }
    }

    function openEditModal(product) {
        document.getElementById('editProductId').value = product.ProductId;
        document.getElementById('editName').value = product.NameProduct;
        document.getElementById('editCategory').value = product.Category;
        document.getElementById('editPrice').value = product.Price;
        document.getElementById('editStock').value = product.Quantity;
        document.getElementById('editDescription').value = product.Description;
        document.getElementById('editTagName').value = product.TagName;
        document.getElementById('editWarranty').value = product.Warranty;
        new bootstrap.Modal(document.getElementById('editProductModal')).show();
    }

    async function saveEditProduct() {
        const form = document.getElementById('editProductForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        const productData = Object.fromEntries(new FormData(form).entries());
        const productId = productData.ProductId;

        const price = parseFloat(productData.Price);
        const quantity = parseInt(productData.Quantity);

        if (price < 0) {
            alert("Giá bán không được âm. Vui lòng nhập lại!");
            document.querySelector('input[name="Price"]').value = '';
            return;
        }
        if (quantity < 0) {
            alert("Số lượng tồn không được âm. Vui lòng nhập lại!");
            document.querySelector('input[name="Quantity"]').value = '';
            return;
        }

        try {
            const response = await fetch(`${API_URL}/seller/products/${productId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(productData),
            });
            const result = await response.json();
            alert(result.message);
            if (result.success) {
                bootstrap.Modal.getInstance(document.getElementById('editProductModal')).hide();
                fetchProducts();
            }
        } catch (error) { 
            console.error("Lỗi saveEditProduct:", error);
            alert('Lỗi khi cập nhật sản phẩm.');
        }
    }

    async function deleteProduct(productId) {
        if (!confirm('Bạn chắc chắn muốn xóa sản phẩm này? Mọi dữ liệu liên quan (đánh giá, giỏ hàng, đơn hàng) cũng sẽ bị xóa vĩnh viễn.')) return;
        try {
            const response = await fetch(`${API_URL}/seller/products/${productId}`, { method: 'DELETE' });
            const result = await response.json();
            alert(result.message);
            if (result.success) fetchProducts();
        } catch (error) {
            console.error("Lỗi deleteProduct:", error);
            alert('Lỗi khi xóa sản phẩm.');
        }
    }
    
    function formatPrice(price) { return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(price); }
</script>
</body>
</html>