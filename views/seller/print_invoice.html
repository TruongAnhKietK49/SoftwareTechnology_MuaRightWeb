<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>In Đơn Hàng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: auto; border: 1px solid #ddd; padding: 30px; }

        body.is-cancelled::before {
            content: "ĐÃ HỦY";
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 10rem;
            color: rgba(255, 0, 0, 0.15); 
            font-weight: bold;
            z-index: -1; 
            pointer-events: none;
        }

        @media print {
            body { padding: 0; }
            .container { border: none; }
        }
    </style>
</head>
<body>
    <div class="container" id="invoice-content">
        <p class="text-center">Đang tải dữ liệu đơn hàng...</p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const dataString = sessionStorage.getItem('printableOrderData');

            if (!dataString) {
                document.getElementById('invoice-content').innerHTML = '<p class="text-center text-danger">Không tìm thấy dữ liệu đơn hàng để in.</p>';
                return;
            }

            sessionStorage.removeItem('printableOrderData');
            const detail = JSON.parse(dataString);

            let title = `THÔNG TIN ĐƠN HÀNG #${detail.OrderId}`;
            let statusBanner = '';

            if (detail.State === 'Cancelled') {
                document.body.classList.add('is-cancelled'); 
                title = `ĐƠN HÀNG #${detail.OrderId}`; 
                statusBanner = `
                    <div style="border: 1px solid red; color: red; background-color: #fff5f5; padding: 15px; text-align: center; margin-bottom: 20px;">
                        <h5 style="margin: 0;">ĐƠN HÀNG NÀY ĐÃ BỊ HỦY</h5>
                        ${detail.CancelReason ? `<p class="mb-0 mt-1"><strong>Lý do:</strong> ${detail.CancelReason}</p>` : ''}
                    </div>
                `; 
            }

            const itemsHtml = detail.Items.map(item => `
                <tr>
                    <td>${item.NameProduct}</td>
                    <td>${item.Quantity}</td>
                    <td>${new Intl.NumberFormat('vi-VN').format(item.UnitPrice)} đ</td>
                    <td>${new Intl.NumberFormat('vi-VN').format(item.LineTotal)} đ</td>
                </tr>
            `).join('');

            const subTotalForSellerHtml = `
                <p><strong>Tổng tiền hàng (của shop):</strong> ${new Intl.NumberFormat('vi-VN').format(detail.SubTotalForSeller)} đ</p>
            `;

            let voucherHtml;
            if (detail.VoucherCode) {
                const discountDisplay = detail.DiscountType === 'Percent'
                    ? `${detail.DiscountVal}%`
                    : `${new Intl.NumberFormat('vi-VN').format(detail.DiscountVal)} đ`;
                voucherHtml = `<p><strong>Voucher áp dụng:</strong> ${detail.VoucherCode} (Giảm ${discountDisplay})</p>`;
            } else {
                 voucherHtml = `<p><strong>Voucher áp dụng:</strong> Không có</p>`;
            }
            
            const discountHtml = detail.DiscountAmt > 0 ?
                `<p><strong>Tổng giảm giá (toàn đơn):</strong> -${new Intl.NumberFormat('vi-VN').format(detail.DiscountAmt)} đ</p>` : '';

            const invoiceHtml = `
                <h2 class="text-center mb-4">${title}</h2>
                ${statusBanner}
                <div class="row mb-4">
                    <div class="col-6">
                        <h5>Từ:</h5>
                        <p class="mb-1"><strong>Cửa hàng:</strong> ${detail.StoreName || 'Chưa có thông tin'}</p>
                        <p class="mb-1"><strong>Địa chỉ:</strong> ${detail.StoreAddress || 'Chưa có thông tin'}</p>
                    </div>
                    <div class="col-6">
                        <h5>Đến:</h5>
                        <p class="mb-1"><strong>Khách hàng:</strong> ${detail.CustomerName}</p>
                        <p class="mb-1"><strong>SĐT:</strong> ${detail.CustomerPhone}</p>
                        <p class="mb-1"><strong>Địa chỉ:</strong> ${detail.CustomerAddress}</p>
                    </div>
                </div>
                <hr>
                <h5>Sản phẩm:</h5>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Sản phẩm</th>
                            <th>SL</th>
                            <th>Đơn giá</th>
                            <th>Thành tiền</th>
                        </tr>
                    </thead>
                    <tbody>${itemsHtml}</tbody>
                </table>
                <div class="text-end mt-4">
                    ${subTotalForSellerHtml}
                    ${voucherHtml}
                    ${discountHtml}
                    <p><strong>Phí vận chuyển (toàn đơn):</strong> ${new Intl.NumberFormat('vi-VN').format(detail.ShippingFee)} đ</p>
                    <p class="mt-4"><i>Cảm ơn quý khách đã mua hàng!</i></p>
                </div>
            `;
            
            document.getElementById('invoice-content').innerHTML = invoiceHtml;
            
            setTimeout(() => {
                window.print();
            }, 500);
        });
    </script>
</body>
</html>