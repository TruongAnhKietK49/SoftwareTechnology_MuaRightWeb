<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>In Đơn Hàng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: auto; border: 1px solid #ddd; padding: 30px; }
        @media print {
            body { padding: 0; }
            .container { border: none; }
        }
    </style>
</head>
<body>
    <div class="container" id="invoice-content">
        <p class="text-center">Đang tải dữ liệu đơn hàng...</p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const dataString = sessionStorage.getItem('printableOrderData');

            if (!dataString) {
                document.getElementById('invoice-content').innerHTML = '<p class="text-center text-danger">Không tìm thấy dữ liệu đơn hàng để in.</p>';
                return;
            }

            sessionStorage.removeItem('printableOrderData');
            const detail = JSON.parse(dataString);
            const storeInfo = { name: "Cửa hàng của bạn", address: "Địa chỉ của bạn" };

            const itemsHtml = detail.Items.map(item => `
                <tr>
                    <td>${item.NameProduct}</td>
                    <td>${item.Quantity}</td>
                    <td>${new Intl.NumberFormat('vi-VN').format(item.UnitPrice)} đ</td>
                    <td>${new Intl.NumberFormat('vi-VN').format(item.LineTotal)} đ</td>
                </tr>
            `).join('');

            const subTotalForSellerHtml = `
                <p><strong>Tổng tiền hàng (của shop):</strong> ${new Intl.NumberFormat('vi-VN').format(detail.SubTotalForSeller)} đ</p>
            `;

            let voucherHtml;
            if (detail.VoucherCode) {
                const discountDisplay = detail.DiscountType === 'Percent'
                    ? `${detail.DiscountVal}%`
                    : `${new Intl.NumberFormat('vi-VN').format(detail.DiscountVal)} đ`;
                voucherHtml = `<p><strong>Voucher áp dụng:</strong> ${detail.VoucherCode} (Giảm ${discountDisplay})</p>`;
            } else {
                 voucherHtml = `<p><strong>Voucher áp dụng:</strong> Không có</p>`;
            }
            
            const discountHtml = detail.DiscountAmt > 0 ?
                `<p><strong>Tổng giảm giá (toàn đơn):</strong> -${new Intl.NumberFormat('vi-VN').format(detail.DiscountAmt)} đ</p>` : '';

            const invoiceHtml = `
                <h2 class="text-center mb-4">THÔNG TIN ĐƠN HÀNG #${detail.OrderId}</h2>
                <div class="row mb-4">
                    <div class="col-6">
                        <h5>Từ:</h5>
                        <p class="mb-1"><strong>Cửa hàng:</strong> ${storeInfo.name}</p>
                        <p class="mb-1"><strong>Địa chỉ:</strong> ${storeInfo.address}</p>
                    </div>
                    <div class="col-6">
                        <h5>Đến:</h5>
                        <p class="mb-1"><strong>Khách hàng:</strong> ${detail.CustomerName}</p>
                        <p class="mb-1"><strong>SĐT:</strong> ${detail.CustomerPhone}</p>
                        <p class="mb-1"><strong>Địa chỉ:</strong> ${detail.CustomerAddress}</p>
                    </div>
                </div>
                <hr>
                <h5>Sản phẩm:</h5>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Sản phẩm</th>
                            <th>SL</th>
                            <th>Đơn giá</th>
                            <th>Thành tiền</th>
                        </tr>
                    </thead>
                    <tbody>${itemsHtml}</tbody>
                </table>
                <div class="text-end mt-4">
                    ${subTotalForSellerHtml}
                    ${voucherHtml}
                    ${discountHtml}
                    <p><strong>Phí vận chuyển (toàn đơn):</strong> ${new Intl.NumberFormat('vi-VN').format(detail.ShippingFee)} đ</p>
                    <p class="mt-4"><i>Cảm ơn quý khách đã mua hàng!</i></p>
                </div>
            `;
            
            document.getElementById('invoice-content').innerHTML = invoiceHtml;
            
            setTimeout(() => {
                window.print();
            }, 500);
        });
    </script>
</body>
</html>