<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Voucher - MuaRight</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../../public/CSS/seller/products_page.css">
    <link rel="stylesheet" href="../../public/CSS/seller/vourchers_page.css">
</head>
<body>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h4><div class="logo-icon"><i class="fas fa-gem"></i></div><span>MuaRight</span></h4>
        </div>
        <ul class="sidebar-menu">
            <li><a href="homeSeller_page.html"><i class="fas fa-chart-line"></i> Dashboard</a></li>
            <li><a href="products_page.html"><i class="fas fa-box"></i> Quản lý sản phẩm</a></li>
            <li><a href="orders_page.html"><i class="fas fa-shopping-cart"></i> Quản lý đơn hàng</a></li>
            <li><a href="vouchers_page.html" class="active"><i class="fas fa-tags"></i> Quản lý Voucher</a></li>
            <li><a href="satisfaction_page.html"><i class="fas fa-chart-bar"></i> Thống kê doanh thu</a></li>
            <li><a href="profileSeller_page.html"><i class="fas fa-cog"></i> Cài đặt trang cá nhân</a></li>
            <li><a href="#logout" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Đăng xuất</a></li>
        </ul>
    </div>


    <div class="main-content">
        <div class="page-header d-flex justify-content-between align-items-center">
            <h2><i class="fas fa-tags"></i> Quản lý Voucher</h2>
            <button class="btn btn-primary" id="showAddVoucherFormBtn">
                <i class="fas fa-plus"></i> Tạo Voucher mới
            </button>
        </div>

        <div id="mainViewContainer">
            <div class="stats-summary" id="voucherStats">
                <div class="stat-box"><i class="fas fa-ticket-alt"></i><h4 id="totalVouchers">0</h4><p>Tổng Voucher</p></div>
                <div class="stat-box"><i class="fas fa-check-circle"></i><h4 id="activeVouchers">0</h4><p>Đang hoạt động</p></div>
                <div class="stat-box"><i class="fas fa-pause-circle"></i><h4 id="inactiveVouchers">0</h4><p>Tạm ngưng</p></div>
                <div class="stat-box"><i class="fas fa-hourglass-end"></i><h4 id="expiredVouchers">0</h4><p>Hết hạn</p></div>
            </div>

            <div class="filter-bar d-flex gap-3 align-items-center" id="filterBar">
                <div class="search-box flex-grow-1">
                    <input type="text" id="searchInput" class="form-control" placeholder="Tìm kiếm theo mã voucher...">
                    <i class="fas fa-search"></i>
                </div>
                <select id="statusFilter" class="form-select w-auto">
                    <option value="">Tất cả trạng thái</option>
                    <option value="Active">Đang hoạt động</option>
                    <option value="Inactive">Tạm ngưng</option>
                    <option value="Expired">Đã hết hạn</option>
                </select>
            </div>

            <div class="row g-4" id="vouchersContainer">
                
            </div>
        </div>

        <div id="addEditVoucherSection" style="display: none;">
             <div class="card-header">
                <h5 class="mb-0" id="formTitle"><i class="fas fa-plus-circle"></i> Tạo Voucher mới</h5>
            </div>
            <div class="card-body">
                <form id="addEditVoucherForm" novalidate>
                    <input type="hidden" name="VoucherId" id="voucherId">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Mã Voucher*</label>
                            <input type="text" class="form-control" name="Code" id="voucherCode" required maxlength="100" placeholder="VD: SALE10K">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Loại giảm giá*</label>
                            <select class="form-select" name="DiscountType" id="discountType" required>
                                <option value="Percent">Giảm theo %</option>
                                <option value="Fixed">Giảm theo số tiền</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label" id="discountValueLabel">Giá trị giảm (%)*</label>
                            <input type="number" class="form-control" name="DiscountVal" id="discountValue" min="0" required placeholder="VD: 10 hoặc 10000">
                        </div>
                         <div class="col-md-6 mb-3">
                            <label class="form-label">Đơn hàng tối thiểu (VNĐ)</label>
                            <input type="number" class="form-control" name="MinOrderAmt" id="minOrderAmt" min="0" placeholder="Bỏ trống nếu không có">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Ngày bắt đầu hiệu lực*</label>
                            <input type="datetime-local" class="form-control" name="ValidFrom" id="validFrom" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Ngày hết hạn*</label>
                            <input type="datetime-local" class="form-control" name="ValidTo" id="validTo" required>
                        </div>
                    </div>
                    
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" role="switch" id="isActiveSwitch" name="IsActive" checked>
                        <label class="form-check-label" for="isActiveSwitch">Kích hoạt voucher ngay</label>
                    </div>

                    <div class="d-flex justify-content-end gap-2 mt-3">
                        <button type="button" class="btn btn-outline-secondary" id="cancelAddEditVoucherBtn">Hủy</button>
                        <button type="submit" class="btn btn-primary" id="submitVoucherBtn"><i class="fas fa-plus"></i> Tạo Voucher</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = "http://localhost:3000/seller";
        let sellerId = null;
        let allVouchers = [];
        let account = null;

        document.addEventListener('DOMContentLoaded', function() {
            const accountString = localStorage.getItem("account");
            if (!accountString) {
                alert("Vui lòng đăng nhập.");
                window.location.href = "../../template/pages/signIn_page.html";
                return;
            }
            account = JSON.parse(accountString);
            if (account.Role !== 'Seller') {
                alert("Bạn không có quyền truy cập trang này.");
                window.location.href = "../../template/pages/signIn_page.html";
                return;
            }
            sellerId = account.AccountId;

            fetchVouchers();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('showAddVoucherFormBtn').addEventListener('click', () => toggleVoucherView(true));
            document.getElementById('cancelAddEditVoucherBtn').addEventListener('click', () => toggleVoucherView(false));
            document.getElementById('addEditVoucherForm').addEventListener('submit', handleFormSubmit);
            document.getElementById('searchInput').addEventListener('input', applyFilters);
            document.getElementById('statusFilter').addEventListener('change', applyFilters);
            document.getElementById('discountType').addEventListener('change', updateDiscountField);
        }

        function toggleVoucherView(showForm, isEdit = false, voucherData = null) {
            const mainView = document.getElementById('mainViewContainer');
            const formView = document.getElementById('addEditVoucherSection');
            const toggleBtn = document.getElementById('showAddVoucherFormBtn');
            const formTitle = document.getElementById('formTitle');
            const submitBtn = document.getElementById('submitVoucherBtn');

            if (showForm) {
                mainView.style.display = 'none';
                formView.style.display = 'block';
                toggleBtn.innerHTML = `<i class="fas fa-list"></i> Quay lại danh sách`;
                
                document.getElementById('addEditVoucherForm').reset();
                document.getElementById('voucherId').value = '';
                document.getElementById('isActiveSwitch').checked = true;

                if (isEdit && voucherData) {
                    formTitle.innerHTML = `<i class="fas fa-edit"></i> Chỉnh sửa Voucher`;
                    submitBtn.innerHTML = `<i class="fas fa-save"></i> Cập nhật`;
                    populateForm(voucherData);
                } else {
                    formTitle.innerHTML = `<i class="fas fa-plus-circle"></i> Tạo Voucher mới`;
                    submitBtn.innerHTML = `<i class="fas fa-plus"></i> Tạo Voucher`;
                }
            } else {
                mainView.style.display = 'block';
                formView.style.display = 'none';
                toggleBtn.innerHTML = `<i class="fas fa-plus"></i> Tạo Voucher mới`;
                fetchVouchers();
            }
        }

        function populateForm(v) {
            document.getElementById('voucherId').value = v.VoucherId;
            document.getElementById('voucherCode').value = v.Code;
            document.getElementById('discountType').value = v.DiscountType;
            document.getElementById('discountValue').value = v.DiscountVal;
            document.getElementById('minOrderAmt').value = v.MinOrderAmt || '';
            document.getElementById('validFrom').value = formatDateTimeLocal(v.ValidFrom);
            document.getElementById('validTo').value = formatDateTimeLocal(v.ValidTo);
            document.getElementById('isActiveSwitch').checked = v.IsActive;
            updateDiscountField();
        }

        async function fetchVouchers() {
            try {
                const response = await fetch(`${API_URL}/vouchers/${sellerId}`);
                const result = await response.json();
                if (result.success) {
                    allVouchers = result.data.map(v => ({ ...v, DisplayStatus: getVoucherDisplayStatus(v) }));
                    displayVouchers(allVouchers);
                    updateStats(allVouchers);
                } else {
                    alert('Lỗi khi tải voucher: ' + result.message);
                }
            } catch (error) { console.error('Lỗi fetchVouchers:', error); }
        }

        function getVoucherDisplayStatus(v) {
            const now = new Date();
            if (new Date(v.ValidTo) < now) return 'Expired';
            if (v.IsActive) return 'Active';
            return 'Inactive';
        }

        function displayVouchers(vouchers) {
            const container = document.getElementById('vouchersContainer');
            container.innerHTML = vouchers.length === 0 ? `<div class="col-12"><p class="text-center text-muted mt-5">Bạn chưa có voucher nào.</p></div>` : '';
            vouchers.forEach(v => container.insertAdjacentHTML('beforeend', createVoucherCard(v)));
        }

        function createVoucherCard(v) {
            const statusMap = {
                Active: { text: 'Đang hoạt động', class: 'bg-success-subtle text-success-emphasis' },
                Expired: { text: 'Đã hết hạn', class: 'bg-secondary-subtle text-secondary-emphasis' },
                Inactive: { text: 'Tạm ngưng', class: 'bg-primary-subtle text-primary-emphasis' }
            };
            const statusInfo = statusMap[v.DisplayStatus];
            const discountText = v.DiscountType === 'Percent' ? `Giảm ${v.DiscountVal}%` : `Giảm ${formatPrice(v.DiscountVal)}`;
            const minOrderText = v.MinOrderAmt > 0 ? `Đơn từ ${formatPrice(v.MinOrderAmt)}` : 'Áp dụng cho mọi đơn hàng';
            const isEditable = v.DisplayStatus !== 'Expired';

            return `
                <div class="col-lg-4 col-md-6">
                    <div class="voucher-card status-${v.DisplayStatus.toLowerCase()}">
                        <div class="voucher-header">
                            <span class="voucher-code">${v.Code}</span>
                            <span class="badge rounded-pill ${statusInfo.class}">${statusInfo.text}</span>
                        </div>
                        <div class="voucher-body">
                            <h5>${discountText}</h5>
                            <p><i class="fas fa-clipboard-list"></i> ${minOrderText}</p>
                            <p><i class="fas fa-calendar-alt"></i> HSD: ${new Date(v.ValidTo).toLocaleDateString('vi-VN')}</p>
                        </div>
                        <div class="voucher-actions">
                            <button class="btn-action btn-edit" onclick='editVoucher(${JSON.stringify(v)})' ${!isEditable ? 'disabled title="Không thể sửa voucher đã hết hạn."' : ''}>
                                <i class="fas fa-edit"></i> Sửa
                            </button>
                            <button class="btn-action btn-delete" onclick="deleteVoucher(${v.VoucherId}, ${sellerId})">
                                <i class="fas fa-trash"></i> Xóa
                            </button>
                        </div>
                    </div>
                </div>`;
        }
        
        function editVoucher(voucher) {
            toggleVoucherView(true, true, voucher);
        }

        async function deleteVoucher(voucherId) {
            if (!confirm('Bạn có chắc chắn muốn xóa vĩnh viễn voucher này?')) return;
            try {
                const response = await fetch(`${API_URL}/vouchers/${voucherId}`, {
                    method: 'DELETE',
                    headers: { 
                        'Content-Type': 'application/json',
                        'x-account': localStorage.getItem('account')
                    }
                });
                const result = await response.json();
                alert(result.message);
                if (result.success) fetchVouchers();
            } catch (error) {
                alert('Lỗi khi xóa voucher.');
                console.error("Lỗi deleteVoucher:", error);
            }
        }

        function updateStats(vouchers) {
            document.getElementById('totalVouchers').textContent = vouchers.length;
            document.getElementById('activeVouchers').textContent = vouchers.filter(v => v.DisplayStatus === 'Active').length;
            document.getElementById('inactiveVouchers').textContent = vouchers.filter(v => v.DisplayStatus === 'Inactive').length;
            document.getElementById('expiredVouchers').textContent = vouchers.filter(v => v.DisplayStatus === 'Expired').length;
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const filtered = allVouchers.filter(v => 
                v.Code.toLowerCase().includes(searchTerm) &&
                (statusFilter === '' || v.DisplayStatus === statusFilter)
            );
            displayVouchers(filtered);
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const MIN_FIXED_DISCOUNT = 1000;

            const voucherCode = document.getElementById('voucherCode').value.trim();
            const discountValue = document.getElementById('discountValue').value;
            const validFrom = document.getElementById('validFrom').value;
            const validTo = document.getElementById('validTo').value;

            if (!voucherCode) {
                alert('Vui lòng nhập Mã Voucher.');
                return;
            }
            if (!discountValue) {
                alert('Vui lòng nhập Giá trị giảm.');
                return;
            }
            if (!validFrom) {
                alert('Vui lòng chọn Ngày bắt đầu hiệu lực.');
                return;
            }
            if (!validTo) {
                alert('Vui lòng chọn Ngày hết hạn.');
                return;
            }

            const voucherData = {
                VoucherId: document.getElementById('voucherId').value,
                Code: voucherCode, 
                DiscountType: document.getElementById('discountType').value,
                DiscountVal: parseFloat(discountValue),
                MinOrderAmt: document.getElementById('minOrderAmt').value ? parseFloat(document.getElementById('minOrderAmt').value) : null,
                ValidFrom: validFrom,
                ValidTo: validTo,
                IsActive: document.getElementById('isActiveSwitch').checked,
                CreatedBySeller: sellerId
            };
            
            if (new Date(voucherData.ValidFrom) >= new Date(voucherData.ValidTo)) {
                alert("Ngày bắt đầu phải trước ngày hết hạn."); 
                return;
            }

            if (voucherData.DiscountType === 'Percent') {
                if (voucherData.DiscountVal <= 0 || voucherData.DiscountVal > 100) {
                    alert('Giá trị giảm theo % phải lớn hơn 0 và không quá 100.');
                    return;
                }
            } else if (voucherData.DiscountType === 'Fixed') {
                if (voucherData.DiscountVal < MIN_FIXED_DISCOUNT) {
                    alert(`Giá trị giảm theo số tiền phải ít nhất là ${MIN_FIXED_DISCOUNT.toLocaleString('vi-VN')} VNĐ.`);
                    return;
                }
                if (voucherData.MinOrderAmt && voucherData.DiscountVal > voucherData.MinOrderAmt) {
                    alert('Số tiền giảm không được lớn hơn giá trị đơn hàng tối thiểu.');
                    return;
                }
            }

            const isUpdating = !!voucherData.VoucherId;
            const method = isUpdating ? 'PUT' : 'POST';
            const url = isUpdating ? `${API_URL}/vouchers/${voucherData.VoucherId}` : `${API_URL}/vouchers`;

            try {
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(voucherData),
                });
                const result = await response.json();
                alert(result.message);
                if (result.success) { toggleVoucherView(false); }
            } catch (error) { alert('Đã xảy ra lỗi khi gửi yêu cầu.'); }
        }

        function handleLogout(e) {
            e.preventDefault();
            if (confirm("Bạn có chắc chắn muốn đăng xuất?")) {
                localStorage.removeItem('account');
                window.location.href = '../../template/pages/signIn_page.html';
            }
        }

        function updateDiscountField() {
            const type = document.getElementById('discountType').value;
            document.getElementById('discountValueLabel').textContent = type === 'Percent' ? 'Giá trị giảm (%)*' : 'Giá trị giảm (VNĐ)*';
        }

        function formatPrice(price) { return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(price); }
        function formatDateTimeLocal(dateString) {
            if (!dateString) return '';
            const d = new Date(dateString);
            d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
            return d.toISOString().slice(0, 16);
        }
    </script>
</body>
</html>