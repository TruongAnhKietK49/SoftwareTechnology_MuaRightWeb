<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seller Dashboard - MuaRight</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../../public/CSS/seller/homeSellerPage.css">
</head>
<body>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h4>
                <div class="logo-icon"><i class="fas fa-gem"></i></div>
                <span>MuaRight</span>
            </h4>
        </div>
        <ul class="sidebar-menu">
            <li><a href="homeSeller_page.html" class="active"><i class="fas fa-chart-line"></i> Dashboard</a></li>
            <li><a href="products_page.html"><i class="fas fa-box"></i> Quản lý sản phẩm</a></li>
            <li><a href="orders_page.html"><i class="fas fa-shopping-cart"></i> Quản lý đơn hàng</a></li>
            <li><a href="vouchers_page.html"><i class="fas fa-tags"></i> Quản lý Voucher</a></li>
            <li><a href="satisfaction_page.html"><i class="fas fa-chart-bar"></i> Thống kê doanh thu</a></li>
            <li><a href="profileSeller_page.html"><i class="fas fa-cog"></i> Cài đặt trang cá nhân</a></li>
           <li><a href="#logout" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Đăng xuất</a></li>
        </ul>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <div>
                <h5>Xin chào, <span id="sellerName">Seller</span></h5>
                <small class="text-muted">Chào mừng trở lại với MuaRight Seller Center</small>
            </div>
            <div class="user-info">
                <div>
                    <div class="text-end">
                        <small class="text-muted d-block">Hôm nay</small>
                        <strong id="currentDate" style="color: var(--primary-dark);"></strong>
                    </div>
                </div>
                <a href="profileSeller_page.html" class="user-avatar-link">
                    <div class="user-avatar" id="userAvatar">NA</div>
                </a>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="stats-card revenue">
                    <div class="icon-wrapper"><i class="fas fa-dollar-sign"></i></div>
                    <h3 id="monthRevenue">0đ</h3><p>Doanh thu tháng này</p>
                    <span class="trend" id="revenueTrend"><i class="fas fa-minus"></i> 0%</span>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="stats-card orders">
                    <div class="icon-wrapper"><i class="fas fa-shopping-bag"></i></div>
                    <h3 id="monthOrders">0</h3><p>Đơn hàng tháng này</p>
                    <span class="trend" id="ordersTrend"><i class="fas fa-minus"></i> 0%</span>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="stats-card products">
                    <div class="icon-wrapper"><i class="fas fa-box-open"></i></div>
                    <h3 id="totalProducts">0</h3><p>Sản phẩm đang bán</p>
                    <span class="trend up" id="productsTrend"><i class="fas fa-plus"></i> +0 mới</span>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="stats-card pending">
                    <div class="icon-wrapper"><i class="fas fa-clock"></i></div>
                    <h3 id="pendingOrders">0</h3><p>Đơn chờ xử lý</p>
                    <span class="trend down" id="pendingTrend"><i class="fas fa-exclamation-triangle"></i> Cần xử lý</span>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <span><i class="fas fa-list"></i> Đơn hàng gần đây</span>
                        <a href="orders_page.html" class="btn btn-sm btn-outline-primary">Xem tất cả</a>
                    </div>
                    <div class="card-body p-0"><div class="table-responsive"><table class="table mb-0">
                        <thead><tr><th>Mã đơn</th><th>Sản phẩm</th><th>Khách hàng</th><th>Số lượng</th><th>Tổng tiền</th><th>Trạng thái</th></tr></thead>
                        <tbody id="recentOrdersTable"></tbody>
                    </table></div></div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header"><span><i class="fas fa-trophy"></i> Top 5 sản phẩm bán chạy</span></div>
                    <div class="card-body" id="topProductsList"></div>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header"><span><i class="fas fa-bell"></i> Thông báo mới nhất</span></div>
                    <div class="card-body" id="notificationsList"></div>
                </div>
            </div>
        </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API_URL = "http://localhost:3000";
    let sellerId = null;

    document.addEventListener('DOMContentLoaded', function() {
        const accountString = localStorage.getItem("account");
        if (!accountString) {
            window.location.href = "../../template/pages/signIn_page.html"; return;
        }
        try {
            const account = JSON.parse(accountString);
            if (account.Role !== 'Seller') {
                window.location.href = "../../template/pages/signIn_page.html"; return;
            }
            sellerId = account.AccountId;
        } catch (e) {
            window.location.href = "../../template/pages/signIn_page.html"; return;
        }
        
        document.getElementById('logoutBtn').addEventListener('click', function(e) {
            e.preventDefault();
            if (confirm("Bạn có chắc chắn muốn đăng xuất?")) {
                localStorage.removeItem('account');
                window.location.href = '../../template/pages/signIn_page.html';
            }
        });
        loadDashboard(sellerId);
        updateDateTime();
    });

    async function loadDashboard(sellerId) {
        try {
            const response = await fetch(`${API_URL}/seller/dashboard/${sellerId}`);
            if (!response.ok) { 
                const errorResult = await response.json();
                throw new Error(errorResult.message || 'Server responded with an error');
            }
            const result = await response.json();
            if (result.success) {
                updateDashboard(result.data);
            } else {
                alert('Không thể tải dữ liệu Dashboard: ' + result.message);
            }
        } catch (error) { 
            console.error('Fetch Error:', error);
            alert('Lỗi kết nối hoặc xử lý từ Server: ' + error.message); 
        }
    }

    function updateDashboard(data) {
        document.getElementById('sellerName').textContent = data.seller.name;
        document.getElementById('userAvatar').textContent = data.seller.name.split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase();
        
        document.getElementById('monthRevenue').textContent = formatPrice(data.stats.monthRevenue);
        updateTrendElement(document.getElementById('revenueTrend'), data.stats.revenueTrend, '%');

        document.getElementById('monthOrders').textContent = data.stats.monthOrders;
        updateTrendElement(document.getElementById('ordersTrend'), data.stats.ordersTrend, '%');
        
        document.getElementById('totalProducts').textContent = data.stats.totalProducts;
        document.getElementById('productsTrend').innerHTML = `<i class="fas fa-plus"></i> +${data.stats.newProducts} mới`;
        
        document.getElementById('pendingOrders').textContent = data.stats.pendingOrders;

        loadRecentOrders(data.recentOrders);
        loadTopProducts(data.topProducts);
        loadNotifications(data.notifications);
    }
    
    function updateTrendElement(element, value, unit) {
        element.classList.remove('up', 'down', 'neutral');
        let icon = '';
        let text = '';

        if (value > 0) {
            element.classList.add('up');
            icon = 'fa-arrow-up';
            text = `+${value}${unit}`;
        } else if (value < 0) {
            element.classList.add('down');
            icon = 'fa-arrow-down';
            text = `${value}${unit}`;
        } else {
            element.classList.add('neutral');
            icon = 'fa-minus';
            text = `0${unit}`;
        }
        element.innerHTML = `<i class="fas ${icon}"></i> ${text}`;
    }
        
    function loadRecentOrders(recentOrders) {
        const tbody = document.getElementById('recentOrdersTable');
        tbody.innerHTML = '';
        const statusConfig = {
            pending: { class: 'bg-warning', text: 'Chờ xác nhận' }, approved: { class: 'bg-info', text: 'Đã xác nhận' },
            shipped: { class: 'bg-primary', text: 'Đang giao' }, delivered: { class: 'bg-success', text: 'Đã giao' },
            cancelled: { class: 'bg-danger', text: 'Đã hủy' }
        };
        if (recentOrders.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">Không có đơn hàng gần đây.</td></tr>`;
            return;
        }
        recentOrders.forEach(order => {
            const config = statusConfig[order.status] || { class: 'bg-secondary', text: order.status };
            tbody.innerHTML += `
                <tr>
                    <td><strong>${order.displayId}</strong></td> <td>${order.product}</td> <td>${order.customer}</td>
                    <td>${order.qty}</td> <td><strong style="color: var(--primary-orange);">${formatPrice(order.total)}</strong></td>
                    <td><span class="badge ${config.class}">${config.text}</span></td>
                </tr>`;
        });
    }

    function loadTopProducts(topProducts) {
        const container = document.getElementById('topProductsList');
        container.innerHTML = '';
        if (topProducts.length === 0) {
            container.innerHTML = `<p class="text-muted text-center">Chưa có sản phẩm nào được bán.</p>`;
            return;
        }
        const badges = ['bg-warning', 'bg-info', 'bg-primary'];
        topProducts.forEach((product, index) => {
            container.innerHTML += `
                <div class="product-item">
                    <div>
                        <strong>${product.name}</strong><br>
                        <small class="text-muted">${product.sold} đơn bán ra</small>
                    </div>
                    <span class="badge ${badges[index] || 'bg-secondary'}">${product.badge}</span>
                </div>`;
        });
    }

    function loadNotifications(notifications) {
        const container = document.getElementById('notificationsList');
        container.innerHTML = '';
        if (notifications.length === 0) return;
        notifications.forEach(notif => {
            container.innerHTML += `<a href="${notif.link}" class="notification-item-link"><div class="notification-item"><div class="d-flex gap-3"><div class="notification-icon ${notif.type}"><i class="fas fa-${notif.icon}"></i></div><div class="flex-grow-1"><strong>${notif.title}</strong><br><small class="text-muted">${notif.message}</small><br><small class="text-muted"><i class="far fa-clock"></i> ${notif.time}</small></div></div></div></a>`;
        });
    }

    function updateDateTime() {
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }
    
    function formatPrice(price) { return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(price); }
</script>
</body>
</html>