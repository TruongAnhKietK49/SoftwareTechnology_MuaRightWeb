<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MuaRight ‚Äì Shop</title>

    <!-- Bootstrap & Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../../public/CSS/user/productPage.css" />
  </head>

  <body>
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top mr-nav">
      <div class="container">
        <a class="navbar-brand brand-xl" href="../../index.html">MuaRight</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#mrNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="mrNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="../../index.html">Trang ch·ªß</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="./Product_Page.html">Shop</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="./Blog_Page.html">Blog</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="../../template/pages/signIn_page.html"
                ><i class="bi bi-person"></i
              ></a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <main>
      <!-- Title -->
      <div class="section-head">
        <h4>‚ú® Danh m·ª•c s·∫£n ph·∫©m</h4>
        <div class="small muted">Trang shop ‚Ä¢ T√¨m ki·∫øm & l·ªçc s·∫£n ph·∫©m</div>
      </div>

      <!-- Filters -->
      <div class="filters">
        <div class="row g-2 align-items-center">
          <div class="col-md">
            <input
              id="searchInput"
              type="search"
              class="form-control"
              placeholder="T√¨m ki·∫øm theo t√™n‚Ä¶"
            />
          </div>
          <div class="col-6 col-md-3">
            <select id="brandSelect" class="form-select">
              <option value="">Th∆∞∆°ng hi·ªáu</option>
            </select>
          </div>
          <div class="col-6 col-md-3">
            <select id="genderSelect" class="form-select">
              <option value="">Gi·ªõi t√≠nh</option>
              <option value="Nam">Nam</option>
              <option value="N·ªØ">N·ªØ</option>
              <option value="Unisex">Unisex</option>
            </select>
          </div>
          <div class="col-md-3">
            <select id="priceSelect" class="form-select">
              <option value="">Kho·∫£ng gi√°</option>
              <option value="0-1000000">0 ‚Äì 1 Tri·ªáu</option>
              <option value="1000000-2000000">2 ‚Äì 3 Tri·ªáu</option>
              <option value="3000000-5000000">3 ‚Äì 5 Tri·ªáu</option>
              <option value="5000000-9999999">5 Tri·ªáu tr·ªü l√™n</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Products grid -->
      <div id="grid" class="grid row g-4"></div>

      <!-- Pagination -->
      <nav class="pager">
        <ul id="pagination" class="pagination"></ul>
      </nav>
    </main>

    <!-- üõçÔ∏è BI·ªÇU T∆Ø·ª¢NG GI·ªé H√ÄNG N·ªîI -->
    <div class="cart-fab position-fixed">
      <button
        id="btnCartFab"
        type="button"
        class="btn btn-gold position-relative rounded-circle shadow-lg"
      >
        <i class="bi bi-bag fs-4"></i>
        <span
          id="cartCount"
          class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
          style="display: none"
          >0</span
        >
      </button>
    </div>

    <!-- üõí MINI CART OFFCANVAS -->
    <div
      class="offcanvas offcanvas-end text-bg-dark"
      tabindex="-1"
      id="offcart"
    >
      <div class="offcanvas-header border-bottom">
        <h5 id="miniCartLabel" class="offcanvas-title">üõí Gi·ªè h√†ng</h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="offcanvas"
          aria-label="Close"
        ></button>
      </div>
      <div class="offcanvas-body small">
        <div id="cartItems" class="list-group small mb-3"></div>
        <div class="border-top pt-3 mt-3">
          <div class="d-flex justify-content-between fw-semibold">
            <span>T·ªïng c·ªông</span>
            <span id="cartTotal">$0</span>
          </div>
          <div class="d-flex justify-content-between mt-3">
            <button id="btnClearCart" class="btn btn-outline-light btn-sm">
              <i class="bi bi-trash me-1"></i> X√≥a gi·ªè
            </button>
            <button class="btn btn-gold btn-sm">
              <i class="bi bi-credit-card me-1"></i> Thanh to√°n
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL CHI TI·∫æT S·∫¢N PH·∫®M -->
    <div class="modal fade" id="productModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 id="pm-title" class="modal-title"></h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="row g-4">
              <div class="col-lg-5">
                <img
                  id="pm-image"
                  class="img-fluid rounded-3 border"
                  style="border-color: var(--border)"
                  alt=""
                />
                <div class="d-flex gap-2 mt-3">
                  <img id="pm-thumb1" class="thumb" alt="" />
                  <img id="pm-thumb2" class="thumb" alt="" />
                </div>
              </div>
              <div class="col-lg-7">
                <div class="d-flex align-items-center gap-2 mb-1">
                  <span
                    id="pm-brand"
                    class="badge rounded-pill badge-tag"
                  ></span>
                  <span id="pm-gender" class="small text-secondary"></span>
                </div>
                <div class="d-flex align-items-center gap-2">
                  <div id="pm-stars" class="stars"></div>
                  <span id="pm-score" class="small text-secondary"></span>
                </div>
                <p id="pm-desc" class="mt-2 small text-secondary"></p>

                <div
                  class="d-flex align-items-center justify-content-between my-2"
                >
                  <div class="fs-4 fw-bold text-gold" id="pm-price"></div>
                  <div class="small text-secondary">
                    M√£: <span id="pm-id"></span>
                  </div>
                </div>

                <div class="row g-2 align-items-center">
                  <div class="col-sm-5">
                    <label class="form-label small">Dung t√≠ch</label>
                    <select id="pm-size" class="form-select">
                      <option value="100" selected>100ml</option>
                    </select>
                  </div>
                  <div class="col-sm-4">
                    <label class="form-label small">S·ªë l∆∞·ª£ng</label>
                    <div class="input-group">
                      <button
                        class="btn btn-outline-gold"
                        id="pm-minus"
                        type="button"
                      >
                        ‚Äì
                      </button>
                      <input
                        id="pm-qty"
                        class="form-control text-center"
                        value="1"
                      />
                      <button class="btn btn-gold" id="pm-plus" type="button">
                        +
                      </button>
                    </div>
                  </div>
                  <div class="col-sm-3 d-grid">
                    <label class="form-label invisible">.</label>
                    <button
                      id="pm-addcart"
                      class="btn btn-gold"
                    >
                      <i class="bi bi-bag-plus me-1"></i>Th√™m v√†o gi·ªè
                    </button>
                  </div>
                </div>

                <hr class="my-3" style="border-color: var(--border)" />

                <h6 class="mb-2">üíé Chi ti·∫øt s·∫£n ph·∫©m</h6>
                <ul id="pm-detail" class="small text-secondary mb-3"></ul>

                <h6 class="mb-2">Reviews</h6>
                <div class="d-flex align-items-center gap-2 mb-2">
                  <div
                    id="pm-stars-big"
                    class="stars"
                    style="font-size: 1.25rem"
                  ></div>
                  <div id="pm-avg" class="fw-semibold"></div>
                  <div class="text-secondary small">
                    (<span id="pm-count"></span> ƒë√°nh gi√°)
                  </div>
                </div>
                <div id="pm-reviews" class="mb-3"></div>

                <h6 class="mb-2">Th√™m ƒë√°nh gi√°</h6>
                <form id="pm-form" class="row g-2">
                  <div class="col-md-3">
                    <select id="rv-rating" class="form-select">
                      <option value="5">5 sao</option>
                      <option value="4">4 sao</option>
                      <option value="3">3 sao</option>
                      <option value="2">2 sao</option>
                      <option value="1">1 sao</option>
                    </select>
                  </div>
                  <div class="col-12">
                    <textarea
                      id="rv-text"
                      class="form-control"
                      rows="2"
                      placeholder="C·∫£m nh·∫≠n c·ªßa b·∫°n‚Ä¶"
                    ></textarea>
                  </div>
                  <div class="col-12">
                    <button class="btn btn-outline-gold" type="submit">
                      <i class="bi bi-send me-1"></i>G·ª≠i ƒë√°nh gi√°
                    </button>
                  </div>
                </form>
                <div
                  id="pm-toast"
                  class="small text-success mt-2"
                  style="display: none"
                >
                  ƒê√£ g·ª≠i ƒë√°nh gi√°! ‚úÖ
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <small class="text-secondary"
              >MuaRight ‚Ä¢ H∆∞∆°ng th∆°m ch√≠nh h√£ng</small
            >
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS (ƒë·∫∑t tr∆∞·ªõc script ch√≠nh ƒë·ªÉ d√πng Offcanvas/Modal) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- JS -->
    <script>
      const account = JSON.parse(localStorage.getItem("account")) || {};
      /* ================= DATA =================== */
      let PRODUCTS = [];
      let PRODUCTS_REVIEW = [];
      async function init() {
        PRODUCTS = await fetch("http://localhost:3000/products/getProductList")
        .then((res) => res.json())
        .then((json) => json.data);

        PRODUCTS_REVIEW = await fetch("http://localhost:3000/products/getProductReview")
        .then((res) => res.json())
        .then((json) => json.data);

        render();
      }

      init();
      const PER_PAGE = 8;

      /* ===== Cart helpers (localStorage) ===== */
      async function getCart(CustomerId) {
        try {
          const res = await fetch("http://localhost:3000/cart/getAllItem/" + CustomerId, {
          method: "GET",
          headers: { "Content-Type": "application/json" },
        });

        if (!res.ok) {
          throw new Error("L·ªói khi l·∫•y danh s√°ch s·∫£n ph·∫©m!");
        }

        const json = await res.json();
        return json.data;
        } catch (e) {
          return [];
        }
      }
      function saveCart(cart) {
        localStorage.setItem("cart", JSON.stringify(cart));
        renderCartUI();
      }
      async function addToCart(p, qty) {
        const CustomerId = account.AccountId;
        const cart = await getCart(CustomerId);
        const found = cart.find((i) => i.ProductId == p.ProductId);
        if (found) {
          found.Quantity += qty;
          await fetch(`http://localhost:3000/cart/update/${found.ProductId}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ Quantity: found.Quantity, UnitPrice: found.Quantity*found.Price }),
          });
        } else {
          await fetch("http://localhost:3000/cart/add", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              CustomerId: account.AccountId,
              ProductId: p.ProductId,
              NameProduct: p.NameProduct,
              Quantity: qty,
              UnitPrice: qty * p.Price,
            }),
          });

          cart.push({
            ProductId: p.ProductId,
            NameProduct: p.NameProduct,
            Price: p.Price,
            ImageUrl: p.ImageUrl,
            qty,
          });
        }
        saveCart(cart);
      }

      /* ===== General helpers ===== */
      const $ = (sel) => document.querySelector(sel);
      function fmtPrice(n) {
        return `$${n}`;
      }

      /* ===== Ratings (user-only, kh√¥ng d√πng seed default) ===== */
      function starIcons(score) {
        const full = Math.floor(score);
        const half = score - full >= 0.5 ? 1 : 0;
        const empty = 5 - full - half;
        return (
          '<i class="bi bi-star-fill"></i>'.repeat(full) +
          (half ? '<i class="bi bi-star-half"></i>' : "") +
          '<i class="bi bi-star"></i>'.repeat(empty)
        );
      }
      const _key = (id) => "reviews_" + id;
      function getUserReviews(id) {
        try {
          return PRODUCTS_REVIEW.filter((e) => e.ProductId == id) || "[]";
        } catch (e) {
          return [];
        }
      }
      function addUserReview(id, review) {
        // const arr = getUserReviews(id);
        // arr.push(review);
        // localStorage.setItem(_key(id), JSON.stringify(arr));
        const res = fetch("http://localhost:3000/products/addReview", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            ProductId: id,
            CustomerId: account.AccountId,
            Rating: review.rating,
            Comment: review.text,
            CreatedAt: new Date().toISOString(),
          }),
        }).then((res) => {
          if (!res.ok) {
            throw new Error("L·ªói khi th√™m ƒë√°nh gi√°!");
          }
        });
      }
      function averageWithUser(p) {
        const user = getUserReviews(p.ProductId);
        const count = user.length;
        const avg = count
          ? user.reduce((s, r) => s + Number(r.Rating || 0), 0) / count
          : 0;
        return { avg, count, desc: "", user };
      }

      /* ===== Populate brand filter ===== */
      function fillBrands() {
        const brands = [...new Set(PRODUCTS.map((p) => p.Brand))].sort();
        const brandSelect = $("#brandSelect");
        brands.forEach((b) => {
          const opt = document.createElement("option");
          opt.value = b;
          opt.textContent = b;
          brandSelect.appendChild(opt);
        });
      };

      /* ===== State from URL ===== */
      function stateFromURL() {
        const params = new URLSearchParams(location.search);
        return {
          q: params.get("q") || "",
          brand: params.get("brand") || "",
          gender: params.get("gender") || "",
          price: params.get("price") || "",
          page: parseInt(params.get("page") || "1", 10),
          highlight: params.get("highlight") || "",
        };
      }
      function pushState(st) {
        const sp = new URLSearchParams();
        if (st.q) sp.set("q", st.q);
        if (st.brand) sp.set("brand", st.brand);
        if (st.gender) sp.set("gender", st.gender);
        if (st.price) sp.set("price", st.price);
        if (st.page > 1) sp.set("page", String(st.page));
        if (st.highlight) sp.set("highlight", st.highlight);
        history.replaceState(null, "", "?" + sp.toString());
      }

      /* ===== Filtering ===== */
      function applyFilters(st) {
        let list = PRODUCTS.slice();
        if (st.q) {
          const q = st.q.trim().toLowerCase();
          list = list.filter((p) => p.NameProduct.toLowerCase().includes(q));
        }
        if (st.brand) list = list.filter((p) => p.Brand === st.brand);
        if (st.gender) list = list.filter((p) => p.Category === st.gender);
        if (st.price) {
          const [minStr, maxStr] = st.price.split("-");
          const min = Number(minStr) || 0;
          const max = Number(maxStr) || 9999999;
          list = list.filter((p) => p.Price >= min && p.Price <= max);
        }
        return list;
      }

      /* ===== Render grid ===== */
      function render() {
        fillBrands();
        const st = stateFromURL();
        $("#searchInput").value = st.q;
        $("#brandSelect").value = st.brand;
        $("#genderSelect").value = st.gender;
        $("#priceSelect").value = st.price;

        const filtered = applyFilters(st);
        const totalPages = Math.max(1, Math.ceil(filtered.length / PER_PAGE));
        if (st.page > totalPages) st.page = totalPages;

        const start = (st.page - 1) * PER_PAGE,
          end = start + PER_PAGE;
        const pageItems = filtered.slice(start, end);

        // grid (c√≥ sao + overlay + n√∫t th√™m mini cart)
        const grid = $("#grid");
        grid.innerHTML = pageItems
          .map((p) => {
            const { avg, count } = averageWithUser(p);
            return `
                <div class="col-6 col-md-3">
                    <div id="${p.ProductId}" class="product-card h-100">
                    <img class="product-thumb" src="${p.ImageUrl}" alt="${p.NameProduct}">
                    <div class="card-overlay">
                        <button class="btn btn-sm btn-outline-light pill" data-view="${
                          p.ProductId
                        }" data-bs-toggle="modal" data-bs-target="#productModal">
                        Xem chi ti·∫øt s·∫£n ph·∫©m <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                    <div class="p-3">
                        <div class="d-flex justify-content-between small mb-1">
                        <span class="badge rounded-pill badge-tag">${
                          p.Brand
                        }</span>
                        <span class="small-muted">${p.Category}</span>
                        </div>
                        <div class="product-title mb-1">${p.NameProduct}</div>
                        <div class="d-flex align-items-center gap-1 mb-2">
                        <span class="stars small">${starIcons(avg)}</span>
                        <span class="small text-secondary">(${count})</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                        <span class="price">${fmtPrice(p.Price)}</span>
                        <button class="btn btn-sm btn-gold" data-cart="${
                          p.ProductId
                        }" title="Th√™m v√†o gi·ªè">
                            <i class="bi bi-bag-plus"></i>
                        </button>
                        </div>
                    </div>
                    </div>
                </div>
                `;
          })
          .join("");

        // pagination
        const pg = $("#pagination");
        let html = "";
        const add = (p, txt, disabled = false, active = false) => {
          html += `<li class="page-item ${disabled ? "disabled" : ""} ${
            active ? "active" : ""
          }">
               <a class="page-link" href="#" data-page="${p}">${txt}</a>
             </li>`;
        };
        add(st.page - 1, "&laquo;", st.page === 1);
        for (let i = 1; i <= totalPages; i++) add(i, i, false, i === st.page);
        add(st.page + 1, "&raquo;", st.page === totalPages);
        pg.innerHTML = html;

        // highlight n·∫øu c√≥
        if (st.highlight) {
          const el = document.getElementById(st.highlight);
          if (el) {
            el.classList.add("highlight");
            el.scrollIntoView({ behavior: "smooth", block: "center" });
          }
        }
        pushState(st);
      }

      /* ===== Listeners filter & pagination ===== */
      document.getElementById("searchInput").addEventListener("input", (e) => {
        const st = stateFromURL();
        st.q = e.target.value;
        st.page = 1;
        st.highlight = "";
        pushState(st);
        render();
      });
      document.getElementById("brandSelect").addEventListener("change", (e) => {
        const st = stateFromURL();
        st.brand = e.target.value;
        st.page = 1;
        st.highlight = "";
        pushState(st);
        render();
      });
      document
        .getElementById("genderSelect")
        .addEventListener("change", (e) => {
          const st = stateFromURL();
          st.gender = e.target.value;
          st.page = 1;
          st.highlight = "";
          pushState(st);
          render();
        });
      document.getElementById("priceSelect").addEventListener("change", (e) => {
        const st = stateFromURL();
        st.price = e.target.value;
        st.page = 1;
        st.highlight = "";
        pushState(st);
        render();
      });
      document.getElementById("pagination").addEventListener("click", (e) => {
        const a = e.target.closest("a.page-link");
        if (!a) return;
        e.preventDefault();
        const st = stateFromURL();
        const p = parseInt(a.dataset.page, 10);
        if (!isNaN(p)) {
          st.page = p;
          st.highlight = "";
          pushState(st);
          render();
        }
      });

      /* ===== Modal cache ===== */
      const pm_title = document.getElementById("pm-title");
      const pm_image = document.getElementById("pm-image");
      const pm_thumb1 = document.getElementById("pm-thumb1");
      const pm_thumb2 = document.getElementById("pm-thumb2");
      const pm_brand = document.getElementById("pm-brand");
      const pm_gender = document.getElementById("pm-gender");
      const pm_price = document.getElementById("pm-price");
      const pm_id = document.getElementById("pm-id");
      const pm_stars = document.getElementById("pm-stars");
      const pm_stars_big = document.getElementById("pm-stars-big");
      const pm_score = document.getElementById("pm-score");
      const pm_avg = document.getElementById("pm-avg");
      const pm_count = document.getElementById("pm-count");
      const pm_desc = document.getElementById("pm-desc");
      const pm_detail = document.getElementById("pm-detail");
      const pm_reviews = document.getElementById("pm-reviews");
      const pm_minus = document.getElementById("pm-minus");
      const pm_plus = document.getElementById("pm-plus");
      const pm_qty = document.getElementById("pm-qty");
      const pm_form = document.getElementById("pm-form");
      const rv_name = document.getElementById("rv-name");
      const rv_rating = document.getElementById("rv-rating");
      const rv_text = document.getElementById("rv-text");
      const pm_toast = document.getElementById("pm-toast");

      /* ===== Open modal from overlay ===== */
      document.addEventListener("click", (e) => {
        const btnView = e.target.closest("[data-view]");
        if (btnView) {
          e.preventDefault();
          openProductModal(btnView.getAttribute("data-view"));
        }
      });

      /* ===== Add to cart from card ===== */
      document.addEventListener("click", (e) => {
        const btnAdd = e.target.closest("[data-cart]");
        if (btnAdd) {
          e.preventDefault();
          const id = btnAdd.getAttribute("data-cart");
          const p = PRODUCTS.find((x) => x.ProductId === id);
          if (p) {
            addToCart(p, 1);
          }
        }
      });

      /* ===== Modal logic ===== */
      const bsModal = new bootstrap.Modal(
        document.getElementById("productModal")
      );
      
      function openProductModal(id) {
        const p = PRODUCTS.find((x) => x.ProductId == id);
        if (!p) return;
        const { avg, count, user } = averageWithUser(p);

        // fill header/info
        pm_title.textContent = p.NameProduct;
        pm_image.src = p.ImageUrl;
        pm_image.alt = p.NameProduct;
        pm_thumb1.src = p.ImageUrl;
        pm_thumb2.src = p.ImageUrl;
        pm_price.textContent = fmtPrice(p.Price);
        pm_id.textContent = p.ProductId;

        // rating
        pm_stars.innerHTML = starIcons(avg);
        pm_stars_big.innerHTML = starIcons(avg);
        pm_score.textContent = `${avg.toFixed(1)} / 5`;
        pm_avg.textContent = `${avg.toFixed(1)} / 5`;
        pm_count.textContent = count;

        // desc + detail (demo)
        pm_desc.textContent = "H∆∞∆°ng th∆°m c√¢n b·∫±ng, d·ªÖ d√πng h·∫±ng ng√†y.";
        pm_detail.innerHTML = "";
        [
          "H∆∞∆°ng ƒë·∫ßu: cam bergamot ‚Äì tr√°i c√¢y t∆∞∆°i.",
          "H∆∞∆°ng gi·ªØa: hoa tr·∫Øng/h·ªìng ‚Äì m·ªãn v√† s√¢u.",
          "H∆∞∆°ng cu·ªëi: g·ªó ‚Äì h·ªï ph√°ch ‚Äì vani ·∫•m √°p.",
          "ƒê·ªô l∆∞u h∆∞∆°ng: 6‚Äì8 gi·ªù ‚Ä¢ ƒê·ªô to·∫£: v·ª´a ‚Äì xa.",
        ].forEach((li) => {
          const el = document.createElement("li");
          el.textContent = li;
          pm_detail.appendChild(el);
        });

        // user reviews
        pm_reviews.innerHTML = user.length
          ? ""
          : '<div class="text-secondary small">Ch∆∞a c√≥ ƒë√°nh gi√° t·ª´ ng∆∞·ªùi d√πng g·∫ßn ƒë√¢y.</div>';
        for (const r of user.slice().reverse()) {
          const d = document.createElement("div");
          d.className = "review-item";
          d.innerHTML = `
          <div class="d-flex align-items-center justify-content-between">
            <div class="fw-semibold">${(r.Name || "Kh√°ch").replace(/</g,"&lt;")}</div>
            <div class="stars">${starIcons(r.Rating)}</div>
          </div>
          <div class="small text-secondary">${new Date(r.CreatedAt).toLocaleString()}</div>
          <div class="mt-1">${(r.Comment || "").replace(/</g, "&lt;")}</div>`;
          pm_reviews.appendChild(d);
        }

        bsModal.show();
      }

      /* ===== Modal qty + submit review ===== */
      pm_minus.addEventListener("click", () => {
        pm_qty.value = Math.max(1, parseInt(pm_qty.value || "1", 10) - 1);
      });
      pm_plus.addEventListener("click", () => {
        pm_qty.value = Math.min(99, parseInt(pm_qty.value || "1", 10) + 1);
      });

      document.getElementById("pm-addcart").addEventListener("click", () => {
        const id = pm_id.textContent;
        const p = PRODUCTS.find((x) => x.ProductId == id);
        const qty = parseInt(pm_qty.value || "1", 10);
        if (p && qty > 0) {
          addToCart(p, qty);
        }
      });

      pm_form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const id = pm_id.textContent;
        addUserReview(id, {
          rating: parseInt(rv_rating.value, 10),
          text: (rv_text.value || "").trim(),
          time: Date.now(),
        });
        rv_text.value = "";
        pm_toast.style.display = "block";
        setTimeout(() => (pm_toast.style.display = "none"), 1500);
        await init();
        openProductModal(id);
      });

      /* ===== MINI CART RENDER ===== */
      async function renderCartUI() {
        // badge
        const CustomerId = account.AccountId;
        const cart = await getCart(CustomerId);
        const totalQty = cart.reduce((s, i) => s + i.Quantity, 0);
        const titleEl = document.getElementById("miniCartLabel");
        if (titleEl) titleEl.textContent = `üõí Gi·ªè h√†ng (${totalQty})`;
        const totalMoney = cart.reduce((s, i) => s + i.Quantity * i.Price, 0);
        const cartCount = document.getElementById("cartCount");
        if (cartCount) {
          cartCount.textContent = totalQty;
          cartCount.style.display = totalQty ? "inline-block" : "none";
        }

        // list items
        const box = document.getElementById("cartItems");
        if (!box) return;
        if (!cart.length) {
          box.innerHTML = `<div class="text-secondary small">Gi·ªè h√†ng ƒëang tr·ªëng.</div>`;
        } else {
          box.innerHTML = cart
            .map(
              (it) => `
                <div class="list-group-item py-3">
                    <div class="d-flex align-items-center">
                    <img src="${it.ImageUrl}" class="cart-thumb me-3" alt="${it.NameProduct}">
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="fw-semibold">${it.NameProduct}</div>
                            <div class="small text-secondary">ƒê∆°n gi√°: ${fmtPrice(
                            it.Price
                            )}</div>
                            <div class="small mt-1">
                            <span class="badge bg-light text-dark">SL: <span data-qty-text="${
                                it.ProductId
                            }">${it.Quantity}</span></span>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-outline-light" data-remove="${
                            it.ProductId
                        }" title="X√≥a">
                          <i class="bi bi-x-lg"></i>
                        </button>
                        </div>

                        <div class="d-flex align-items-center gap-2 mt-2">
                        <div class="input-group input-group-sm" style="width:140px">
                            <button class="btn btn-outline-gold" data-dec="${
                            it.ProductId
                            }" type="button">‚Äì</button>
                            <input class="form-control text-center" value="${it.Quantity}" disabled>
                            <button class="btn btn-gold" data-inc="${
                            it.ProductId
                            }" type="button">+</button>
                        </div>
                        <div class="ms-auto fw-semibold">${fmtPrice(it.Quantity * it.Price)}</div>
                        </div>
                    </div>
                    </div>
                </div>
                `
            )
            .join("");
        }

        const totalEl = document.getElementById("cartTotal");
        if (totalEl) totalEl.textContent = fmtPrice(totalMoney);
      }

      /* === Mini cart actions === */
      document.getElementById("cartItems").addEventListener("click", async (e) => {
        const CustomerId = account.AccountId;
        const cart = await getCart(CustomerId);
        const idInc = e.target.closest("[data-inc]")?.getAttribute("data-inc");
        const idDec = e.target.closest("[data-dec]")?.getAttribute("data-dec");
        const idRem = e.target
          .closest("[data-remove]")
          ?.getAttribute("data-remove");

        if (idInc) {
          const it = cart.find((x) => x.ProductId == idInc);
          if (it) {
            it.Quantity++;
            await fetch(`http://localhost:3000/cart/update/${idInc}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ Quantity: it.Quantity, UnitPrice: it.Quantity*it.Price }),
            });
            saveCart(cart);
          }
        }

        if (idDec) {
          const it = cart.find((x) => x.ProductId == idDec);
          if (it) {
            it.Quantity = Math.max(1, it.Quantity - 1);
            await fetch(`http://localhost:3000/cart/update/${idDec}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ Quantity: it.Quantity, UnitPrice: it.Price }),
            });
            saveCart(cart);
          }
        }
        if (idRem) {
          const idx = cart.findIndex((x) => x.ProductId == idRem);
          if (idx > -1) {
            await fetch(`http://localhost:3000/cart/remove/${idRem}`, {
              method: "DELETE",
              headers: { "Content-Type": "application/json" },
            });
            saveCart(cart);
          }
        }
      });

      document.getElementById("btnClearCart").addEventListener("click", async() => {
        localStorage.removeItem("cart");
        await fetch("http://localhost:3000/cart/clear", {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
        });
        renderCartUI();
      });

      // --- FAB: k√©o kh√¥ng m·ªü, ch·ªâ nh·∫•n m·ªõi m·ªü; kh√¥ng d√≠nh chu·ªôt
      (function () {
        const fab = document.querySelector(".cart-fab");
        const fabBtn = document.getElementById("btnCartFab");
        const offEl = document.getElementById("offcart");
        if (!fab || !fabBtn || !offEl) return;

        let dragging = false;
        let moved = false;
        let startX = 0,
          startY = 0;
        let offsetX = 0,
          offsetY = 0;
        let pointerId = null;

        fab.style.touchAction = "none";
        fab.style.cursor = "grab";

        function onMove(e) {
          if (!dragging) return;
          const dx = e.clientX - startX;
          const dy = e.clientY - startY;
          if (Math.abs(dx) > 5 || Math.abs(dy) > 5) moved = true;
          if (!moved) return;

          const x = e.clientX - offsetX;
          const y = e.clientY - offsetY;
          fab.style.left = `${x}px`;
          fab.style.top = `${y}px`;
          fab.style.right = "auto";
          fab.style.bottom = "auto";
          fab.style.transform = "none";

          e.preventDefault(); // ngƒÉn click ‚Äúl·ªçt‚Äù
        }

        function openCart() {
          const cart = bootstrap.Offcanvas.getOrCreateInstance(offEl);
          cart.show();
        }

        function onUp(e) {
          if (!dragging) return;
          dragging = false;
          fab.classList.remove("dragging");
          try {
            if (pointerId !== null) fabBtn.releasePointerCapture(pointerId);
          } catch (_) {}
          pointerId = null;

          // b·ªè l·∫Øng nghe to√†n c·ª•c
          document.removeEventListener("pointermove", onMove);
          document.removeEventListener("pointerup", onUp);
          document.removeEventListener("pointercancel", onUp);

          // n·∫øu KH√îNG k√©o, coi nh∆∞ nh·∫•n -> m·ªü gi·ªè
          if (!moved) openCart();

          // reset c·ªù "v·ª´a k√©o" sau m·ªôt tick ƒë·ªÉ click ti·∫øp theo kh√¥ng m·ªü
          setTimeout(() => {
            moved = false;
          }, 0);
        }

        fabBtn.addEventListener("pointerdown", (e) => {
          dragging = true;
          moved = false;
          fab.classList.add("dragging");
          pointerId = e.pointerId;
          try {
            fabBtn.setPointerCapture(pointerId);
          } catch (_) {}

          const rect = fab.getBoundingClientRect();
          startX = e.clientX;
          startY = e.clientY;
          offsetX = startX - rect.left;
          offsetY = startY - rect.top;

          // l·∫Øng nghe tr√™n document ƒë·ªÉ lu√¥n nh·∫≠n ƒë∆∞·ª£c s·ª± ki·ªán nh·∫£
          document.addEventListener("pointermove", onMove, { passive: false });
          document.addEventListener("pointerup", onUp, { passive: false });
          document.addEventListener("pointercancel", onUp, { passive: false });
        });

        // ch·∫∑n click sau khi v·ª´a k√©o
        fabBtn.addEventListener("click", (e) => {
          if (dragging || moved) {
            e.preventDefault();
            e.stopImmediatePropagation();
          } else {
            openCart();
          }
        });
      })();

      /* ===== Boot ===== */
      function setNavH() {
        const nav = document.querySelector(".navbar");
        if (!nav) return;
        const h = nav.offsetHeight || 72;
        document.documentElement.style.setProperty("--nav-h", h + "px");
      }
      window.addEventListener("load", setNavH);
      window.addEventListener("resize", setNavH);
      if (document.fonts && document.fonts.ready) {
        document.fonts.ready.then(setNavH);
      }

      render();
      renderCartUI();
    </script>
    <!-- FOOTER CONTAINER -->

    <div id="footer-container"></div>

    <!-- Script t·ª± ƒë·ªông t·∫£i footer -->
    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const box = document.getElementById("footer-container");
        if (!box) return;

        // C√°c ƒë∆∞·ªùng d·∫´n kh·∫£ d·ª•ng t√πy v·ªã tr√≠ trang
        const paths = [
          "../../template/includes/footer.html", // n·∫øu trang n·∫±m s√¢u 2 c·∫•p (vd: views/user/shop.html)
          "../template/includes/footer.html", // n·∫øu trang n·∫±m s√¢u 1 c·∫•p (vd: views/shop.html)
          "template/includes/footer.html", // n·∫øu file ·ªü root
          "partials/footer.html", // fallback
          "footer.html", // fallback cu·ªëi
        ];

        for (const p of paths) {
          try {
            const res = await fetch(p, { cache: "no-cache" });
            if (res.ok) {
              const html = await res.text();
              box.innerHTML = html;

              // G√°n nƒÉm hi·ªán t·∫°i v√†o ph·∫ßn t·ª≠ c√≥ id="mr-year"
              const yearEl = box.querySelector("#mr-year");
              if (yearEl) yearEl.textContent = new Date().getFullYear();
              return; // D·ª´ng l·∫°i khi ƒë√£ t·∫£i th√†nh c√¥ng
            }
          } catch (e) {
            // Th·ª≠ ƒë∆∞·ªùng d·∫´n k·∫ø ti·∫øp
          }
        }

        console.error("‚ùå Kh√¥ng t·∫£i ƒë∆∞·ª£c footer t·ª´ c√°c ƒë∆∞·ªùng d·∫´n:", paths);
      });
    </script>
  </body>
</html>
